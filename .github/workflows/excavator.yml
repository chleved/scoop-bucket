name: Bucket Auto-Updater
on:
  schedule:
    # Run once daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allows you to run it manually from the Actions tab

jobs:
  excavate:
    name: Excavate
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Excavate
        uses: ScoopInstaller/GithubActions@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MANIFESTS_LOCATION: 'bucket'

      # Check if Excavator actually committed any manifest updates.
      # Writes updated=true to GITHUB_OUTPUT only if bucket/ files changed.
      # All subsequent steps are gated on this â€” no new release = no VT scan.
      - name: Check if manifests were updated
        id: check_updates
        shell: powershell
        run: |
          $diff = git show --name-only --format="" HEAD -- bucket/
          if ($diff) {
            Write-Host "Manifests updated:"
            Write-Host $diff
            echo "updated=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No manifest changes detected, skipping VT scan."
            echo "updated=false" >> $env:GITHUB_OUTPUT
          }

      - name: Download installers for VT scanning
        if: steps.check_updates.outputs.updated == 'true'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path "$env:RUNNER_TEMP\vt-scan" -Force | Out-Null
          Get-ChildItem -Path "bucket" -Filter "*.json" | ForEach-Object {
            $json = Get-Content $_.FullName | ConvertFrom-Json
            $url = $json.url
            if (-not $url) { return }

            # Resolve $version template if Excavator left it unresolved
            $url = $url -replace '\$version', $json.version

            $filename = [System.IO.Path]::GetFileName(($url -split '\?')[0])
            Write-Host "Downloading $filename from $url"
            Invoke-WebRequest -Uri $url -OutFile "$env:RUNNER_TEMP\vt-scan\$filename" `
              -MaximumRedirection 10 -UseBasicParsing
          }

      - name: VirusTotal Scan
        if: steps.check_updates.outputs.updated == 'true'
        uses: crazy-max/ghaction-virustotal@v4
        with:
          vt_api_key: ${{ secrets.VT_API_KEY }}
          request_rate: 4
          files: |
            ${{ runner.temp }}/vt-scan/*